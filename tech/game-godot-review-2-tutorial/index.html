<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.96.0"><meta name=theme-color content="#fff"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>复习 Godot 开发流程 其二 重温教程 | Everybody Wants Some</title><link rel=stylesheet href=/css/meme.min.9d8ef948f1ba81e0407775cc502ba3df2886b1764e0060b39407fffba42bff38.css><script src=/js/meme.min.d001b05c04cce10a61f2d919c43f9f563889ea176cb110b472e7e417f41abd77.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Rock+Salt&family=Ma+Shan+Zheng&family=IBM+Plex+Serif:ital,wght@0,400;0,600;1,400;1,600&family=Noto+Sans+SC:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Source+Code+Pro:ital,wght@0,400;0,600;1,400;1,600&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=ZCOOL+KuaiLe&display=swap" media=print onload='this.media="all"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Rock+Salt&family=Ma+Shan+Zheng&family=IBM+Plex+Serif:ital,wght@0,400;0,600;1,400;1,600&family=Noto+Sans+SC:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Source+Code+Pro:ital,wght@0,400;0,600;1,400;1,600&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=ZCOOL+KuaiLe&display=swap"></noscript><meta name=author content="time2beat"><meta name=description content="还是本杰明大佬的「Make an Action RPG in Godot 3.2」（素材）这个教程。 这应该是刷第四遍了，真……"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=mask-icon href=/icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="Everybody Wants Some"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="Everybody Wants Some"><meta name=msapplication-starturl content="../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../icons/mstile-150x150.png"><link rel=manifest href=/manifest.json><link rel=canonical href=https://ews.ink/tech/game-godot-review-2-tutorial/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2022-04-09T19:36:54+08:00","dateModified":"2022-10-25T19:28:41+08:00","url":"https://ews.ink/tech/game-godot-review-2-tutorial/","headline":"复习 Godot 开发流程 其二 重温教程","description":"还是本杰明大佬的「Make an Action RPG in Godot 3.2」（素材）这个教程。 这应该是刷第四遍了，真……","inLanguage":"zh-CN","articleSection":"tech","wordCount":10332,"image":["https://s2.loli.net/2022/04/10/cF3E2QujLUA5YdC.png"],"author":{"@type":"Person","description":"Everybody Wants Some","email":"po@ews.ink","image":"https://ews.ink/icons/avatar.jpg","url":"https://ews.ink/","name":"time2beat"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)","publisher":{"@type":"Organization","name":"Everybody Wants Some","logo":{"@type":"ImageObject","url":"https://ews.ink/icons/apple-touch-icon.png"},"url":"https://ews.ink/"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://ews.ink/"}}</script><meta name=twitter:card content="summary_large_image"><meta property="og:title" content="复习 Godot 开发流程 其二 重温教程"><meta property="og:description" content="还是本杰明大佬的「Make an Action RPG in Godot 3.2」（素材）这个教程。 这应该是刷第四遍了，真……"><meta property="og:url" content="https://ews.ink/tech/game-godot-review-2-tutorial/"><meta property="og:site_name" content="Everybody Wants Some"><meta property="og:locale" content="zh"><meta property="og:image" content="https://s2.loli.net/2022/04/10/cF3E2QujLUA5YdC.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-04-09T19:36:54+08:00"><meta property="article:modified_time" content="2022-10-25T19:28:41+08:00"><meta property="article:section" content="tech"></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=/ class=brand>Everybody Wants Some</a></div><nav class=nav><ul class=menu id=menu><li class=menu-item><a href=/tags/><span class=menu-item-name>标签</span></a></li><li class=menu-item><a href=/tech/><span class=menu-item-name>技术</span></a></li><li class=menu-item><a href=/game/><span class=menu-item-name>游戏</span></a></li><li class=menu-item><a href=/life/><span class=menu-item-name>生活</span></a></li><li class=menu-item><a href=/about/><span class=menu-item-name>关于</span></a></li><li class=menu-item><a id=theme-switcher href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5 242 7a18 18 0 0128 0l48.8 97.5L422.2 70A18 18 0 01442 89.8l-34.5 103.4L505 242a18 18 0 010 28l-97.5 48.8L442 422.2A18 18 0 01422.2 442l-103.4-34.5L270 505a18 18 0 01-28 0l-48.8-97.5L89.8 442A18 18 0 0170 422.2l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8L70 89.8A18 18 0 0189.8 70zM256 128a128 128 0 10.01.0M256 160a96 96 0 10.01.0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412A256 256 0 10181 5a11.5 11.5.0 00-5 20A201.5 201.5.0 0142 399a11.5 11.5.0 00-15 13"/></svg></a></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=justify data-type=tech data-toc-num=true><h1 class="post-title p-name">复习 Godot 开发流程 其二 重温教程</h1><div class="post-subtitle p-name">First Godot Demo Code Review</div><div class=post-meta><time datetime=2022-04-09T19:36:54+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2022.4.9</time>
<time datetime=2022-10-25T19:28:41+08:00 class="post-meta-item modified dt-updated"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M4e2 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627.0-12 5.373-12 12v52H48C21.49 64 0 85.49.0 112v352c0 26.51 21.49 48 48 48h352c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V160h352v298a6 6 0 01-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2022.10.25</time>
<span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href=/tech/ class="category-link p-category">Tech</a></span>
<span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;10332</span>
<span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;21&nbsp;分钟</span>
<span class="post-meta-item busuanzi-page-pv" id=busuanzi_container_page_pv><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="icon post-meta-icon"><path d="M288 144a110.94 110.94.0 00-31.24 5 55.4 55.4.0 017.24 27 56 56 0 01-56 56 55.4 55.4.0 01-27-7.24A111.71 111.71.0 10288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35.0 000 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35.0 000-29.19zM288 4e2c-98.65.0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 4e2 288 4e2z"/></svg>&nbsp;<span id=busuanzi_value_page_pv></span></span></div><nav class=contents><h2 id=contents class=contents-title>目录</h2><ol class=toc><li><a id=contents:项目设置 href=#项目设置>项目设置</a></li><li><a id=contents:引入角色 href=#引入角色>引入角色</a></li><li><a id=contents:简单-fsm有限状态机和控制角色移动 href=#简单-fsm有限状态机和控制角色移动>简单 FSM（有限状态机）和控制角色移动</a></li><li><a id=contents:给角色添加碰撞体以及-ysort-自动排序 href=#给角色添加碰撞体以及-ysort-自动排序>给角色添加碰撞体以及 YSort 自动排序</a></li><li><a id=contents:给角色添加动作动画 href=#给角色添加动作动画>给角色添加动作动画</a></li><li><a id=contents:设置游戏背景图像 href=#设置游戏背景图像>设置游戏背景图像</a></li><li><a id=contents:利用-tilemap-节点自动铺砖 href=#利用-tilemap-节点自动铺砖>利用 TileMap 节点自动铺砖</a></li><li><a id=contents:给-tilemap-添加碰撞体 href=#给-tilemap-添加碰撞体>给 TileMap 添加碰撞体</a></li><li><a id=contents:区域检测hitbox--hurtbox href=#区域检测hitbox--hurtbox>区域检测（Hitbox & Hurtbox）</a></li><li><a id=contents:击退效果和伤害属性 href=#击退效果和伤害属性>击退效果和伤害属性</a></li><li><a id=contents:抽象出特效动画 href=#抽象出特效动画>抽象出特效动画</a></li><li><a id=contents:小怪-ai索敌 href=#小怪-ai索敌>小怪 AI：索敌</a></li><li><a id=contents:添加无敌帧避免短时间内被大量判定伤害次数 href=#添加无敌帧避免短时间内被大量判定伤害次数>添加无敌帧（避免短时间内被大量判定伤害次数）</a></li><li><a id=contents:血量显示 href=#血量显示>血量显示</a></li><li><a id=contents:敌人之间的软碰撞伪物理 href=#敌人之间的软碰撞伪物理>敌人之间的软碰撞（伪物理）</a></li><li><a id=contents:镜头设置 href=#镜头设置>镜头设置</a></li><li><a id=contents:小怪-ai巡逻游荡 href=#小怪-ai巡逻游荡>小怪 AI：巡逻（游荡）</a></li><li><a id=contents:音效 href=#音效>音效</a></li><li><a id=contents:视觉特效着色器 href=#视觉特效着色器>视觉特效（着色器）</a></li></ol></nav><div class="post-body e-content"><p>还是本杰明大佬的「<a href=https://youtu.be/mAbG8Oi-SvQ target=_blank rel=noopener>Make an Action RPG in Godot 3.2</a>」（<a href=https://github.com/uheartbeast/youtube-tutorials target=_blank rel=noopener>素材</a>）这个教程。<br>这应该是刷第四遍了，真的不错。常用的基础知识点比较全面，学习曲线也很平缓。</p><p>我是一个<strong>巨讨厌</strong>视频教程的人，因为视频往往意味着追求「泛用」「通识」，和「因材施教」这个词完全是反着来的。<br>文本我可以自由控制阅读速度，简单的一目了然那就读快点，复杂的就反反复复多读几遍。<br>甚至不用翻页，抬抬眼皮挪动目光就可以。视频呢？</p><ul><li>过于简单的常识你听着的同时几乎没有办法控制地油然而生一股焦躁。<br>我的时间非常宝贵，真的没有那么多生命给你浪费。<br>你还不敢随便拉进度条，因为你不知道对方什么时候会突然讲一个核心重点——<br>也许你打开这个视频的全部目的就只是为了这一个重点。你根本无从预料。</li><li>复杂的知识需要反复观看来加深理解，你只能拖进度条，还不知道具体应该拖到什么位置。<br>重看几遍就要拖几遍进度条，冲着学习去上过网课的大概都懂，这真的是巨大的心力成本。</li></ul><p>拿沐浴来打比方，文档 / 图文教程就像淋浴，你随时可以选择抽身离开或者直接关掉水龙头。<br>视频教程就像泡澡，舒服肯定比淋浴舒服，但对其本身的硬性条件要求很高，水温太凉或者太烫（你已经<ruby><rb>泡在里面</rb><rp>（</rp><rt>打开视频</rt><rp>）</rp></ruby>）都会让你想打人。</p><p>但做的好的视频教程还是有，本哥这个视频的信息密度就属于我能接受的程度。<br>虽然还是有点初级 / 啰嗦；不过考虑到质量可以容忍，对我来说完全没问题。<del>水温非常舒适</del></p><p>由于我这是 n 进宫了就不记那些过于基础的知识点了，此处只记录涉及到的相关最佳实践。</p><h2 id=项目设置><a href=#项目设置 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:项目设置 class=headings>项目设置</a></h2><ol><li>像素风格小图片素材<ruby><rb>导入</rb><rp>（</rp><rt>Import</rt><rp>）</rp></ruby>时 <strong>不能勾</strong>「Filter」，最好「<ruby><rb>预设</rb><rp>（</rp><rt>Preset</rt><rp>）</rp></ruby>」改成 <code>2D Pixel</code>。<br>如果后续的图片素材也同样都是像素风，可以把这个预设 <code>2D Pixel</code> 设为默认。</li><li>菜单栏 →「Project」→「Project Settings...」→「General」标签——<br>再选中「Display」栏的「Window」项设置游戏窗口。<br>开头的 <code>Width/Height</code> 是「真实尺寸」，<code>Test Width/Height</code> 是「调试时显示尺寸」。<br>记得拉到最下面的<ruby><rb>拉伸</rb><rp>（</rp><rt>Stretch</rt><rp>）</rp></ruby>，启用 <code>viewport</code> <ruby><rb>模式</rb><rp>（</rp><rt>Mode</rt><rp>）</rp></ruby>，<ruby><rb>方向</rb><rp>（</rp><rt>Aspect</rt><rp>）</rp></ruby>选为 <code>keep</code>（保持横纵比）。</li></ol><h2 id=引入角色><a href=#引入角色 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:引入角色 class=headings>引入角色</a></h2><ol><li>添加 <code>KinematicBody2D</code> 节点（运动学物体、即会动的物理碰撞体）并命名为 <code>Player</code> 作为玩家的载体，以确保我们以后能控制它行动。</li><li>可以观察到 <code>KinematicBody2D</code> 节点本身是不可见的，所以还要给它添加一个 <code>Sprite</code> 子节点，用来显示玩家的形象。</li><li>把用到的 PNG Sprite 素材拖到 <code>Sprite</code> 节点的<ruby><rb>材质</rb><rp>（</rp><rt>Texture</rt><rp>）</rp></ruby>，把<ruby><rb>动画设置项</rb><rp>（</rp><rt>Animation</rt><rp>）</rp></ruby>的<ruby><rb>水平帧</rb><rp>（</rp><rt>Hframes</rt><rp>）</rp></ruby>调成素材对应的帧数（这个教程里用的素材是 <code>60</code>）。</li><li>选中 <code>KinematicBody2D</code> 节点，勾选锁定右边的「Makes sure the object's children are not selectable.（确保子对象不能被选中）」，绑定属于玩家的整棵节点树。</li><li>右键 <code>KinematicBody2D</code> 节点选择「Save Branch as Scene（将分支另存为独立场景）」。</li></ol><h2 id=简单-fsm有限状态机和控制角色移动><a href=#简单-fsm有限状态机和控制角色移动 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:简单-fsm有限状态机和控制角色移动 class=headings>简单 FSM（有限状态机）和控制角色移动</a></h2><p>给 Player 添加脚本。没啥好说的，都在注释里了：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=k>enum</span> <span class=p>{</span> <span class=n>IDLE</span><span class=p>,</span> <span class=n>MOVE</span><span class=p>,</span> <span class=n>ROLL</span><span class=p>,</span> <span class=n>ATTACK</span> <span class=p>}</span>  <span class=c1># 枚举状态自动机所有状态 所谓&#34;有限&#34;嘛</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 导出变量的好处是可以在调试游戏时**即时调整数值**动态观察效果</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>max_speed</span> <span class=o>=</span> <span class=mf>100.0</span>  <span class=c1># 移速上限</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>acceleration</span> <span class=o>=</span> <span class=mf>25.0</span>  <span class=c1># 加速度 可以理解为角色的移动力</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>friction</span> <span class=o>=</span> <span class=mf>10.0</span>  <span class=c1># 环境摩擦力</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>roll_speed</span> <span class=o>=</span> <span class=mf>125.0</span>  <span class=c1># 翻滚速度 暂时没用上</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>face_aspect</span><span class=p>:</span> <span class=ne>Vector2</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>  <span class=c1># 面向矢量</span>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>move_vector</span><span class=p>:</span> <span class=ne>Vector2</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>  <span class=c1># 移动矢量</span>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_action_state</span> <span class=o>=</span> <span class=n>IDLE</span>  <span class=c1># 记录状态机的状态</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>match</span> <span class=bp>self</span><span class=o>.</span><span class=n>_action_state</span><span class=p>:</span>  <span class=c1># 根据状态机变化执行对应动作</span>
</span></span><span class=line><span class=cl>		<span class=n>ROLL</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>do_roll</span><span class=p>()</span>  <span class=c1># 翻滚</span>
</span></span><span class=line><span class=cl>		<span class=n>ATTACK</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>do_attack</span><span class=p>()</span>  <span class=c1># 攻击</span>
</span></span><span class=line><span class=cl>		<span class=n>_</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>do_move</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>  <span class=c1># 移动</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_unhandled_input</span><span class=p>(</span><span class=n>_event</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>input_vector</span><span class=p>:</span> <span class=ne>Vector2</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>
</span></span><span class=line><span class=cl>	<span class=n>input_vector</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=ne>Input</span><span class=o>.</span><span class=n>get_action_strength</span><span class=p>(</span><span class=s2>&#34;ui_right&#34;</span><span class=p>)</span> <span class=o>-</span> <span class=ne>Input</span><span class=o>.</span><span class=n>get_action_strength</span><span class=p>(</span><span class=s2>&#34;ui_left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>input_vector</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=ne>Input</span><span class=o>.</span><span class=n>get_action_strength</span><span class=p>(</span><span class=s2>&#34;ui_down&#34;</span><span class=p>)</span> <span class=o>-</span> <span class=ne>Input</span><span class=o>.</span><span class=n>get_action_strength</span><span class=p>(</span><span class=s2>&#34;ui_up&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>#print(&#34;[DEBUG] 当前移动方向&#34;, input_vector)</span>
</span></span><span class=line><span class=cl>	<span class=bp>self</span><span class=o>.</span><span class=n>face_aspect</span>  <span class=o>=</span> <span class=n>input_vector</span><span class=o>.</span><span class=n>normalized</span><span class=p>()</span>  <span class=c1># 归一化向量 防止对角线(√2)移动更快</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>face_aspect</span> <span class=o>==</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>_action_state</span> <span class=o>=</span> <span class=n>IDLE</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>_action_state</span> <span class=o>=</span> <span class=n>MOVE</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=ne>Input</span><span class=o>.</span><span class=n>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;action_attack&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>_action_state</span> <span class=o>=</span> <span class=n>ATTACK</span>  <span class=c1># 同时移动优先攻击</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=ne>Input</span><span class=o>.</span><span class=n>is_action_just_pressed</span><span class=p>(</span><span class=s2>&#34;action_roll&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>_action_state</span> <span class=o>=</span> <span class=n>ROLL</span>  <span class=c1># 同时攻击优先翻滚</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_move</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>face_aspect</span> <span class=o>!=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span>  <span class=c1># 被摩擦力逼停</span>
</span></span><span class=line><span class=cl>				<span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nb>clamp</span><span class=p>(</span><span class=n>friction</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=n>delta</span><span class=p>)</span>  <span class=c1># 物理帧补正卡顿</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span>  <span class=c1># 克服摩擦力做功</span>
</span></span><span class=line><span class=cl>				<span class=bp>self</span><span class=o>.</span><span class=n>face_aspect</span> <span class=o>*</span> <span class=n>max_speed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nb>clamp</span><span class=p>(</span><span class=n>acceleration</span> <span class=o>-</span> <span class=n>friction</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=n>delta</span><span class=p>)</span>  <span class=c1># 不能为负导致反向加速</span>
</span></span><span class=line><span class=cl>	<span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span> <span class=o>=</span> <span class=n>move_and_slide</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span><span class=p>)</span>  <span class=c1># 自动处理物理帧补正卡顿</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_attack</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[DEBUG] 攻击输入判定帧&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_roll</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[DEBUG] 翻滚输入判定帧&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><p>稍微解释一下以上设计：<br>移速上限为 <code>100</code>，如果没有摩擦力会在 $ 100 \div 25 = 4 $ 帧之内从<strong>静止</strong>逐渐加速直至移速上限。<br>而有了摩擦力就至少需要 $ \lfloor 100 \div (25 - 10) \rfloor = 6 $ 帧用来加速，同时停止运动时也会体现渐出的丝滑效果，符合事实逻辑。<br>Godot 也是标准的一秒 60 帧（再强调一次是后端的物理运算帧，不是前端的渲染帧），算下来一帧也就 0.02 秒不到，你也许会质疑多这两帧有啥意义。但话不是这样讲的。<br>一个游戏所谓的手感真不是玄学，都是无数个这样毫不起眼的细节堆出来的。</p><p>就算不提手感这种很主观的概念，很多游戏内部的重要机制也取决于此。<br>比如《剑网 3》的「加速」属性，为什么要分段？为什么加速属性的收益是阶梯式的？<br>如果 2 帧不重要，那大附魔小附魔小药小吃之类的增益不也是蚊子腿吗？为什么那么贵？</p><p>而且质疑「区区游戏，何论手感？」其实是一件很没道理的事。<br>照这么说 FTG（格斗游戏）的动画取消、立回、确反都是笑话咯？小心被真人格斗。<br>你做不到不代表别人做不到。<br>有人真的是按帧玩游戏的，《任天堂明星大乱斗 <ruby><rb>Melee</rb><rp>（</rp><rt>日版叫 DX</rt><rp>）</rp></ruby>》的 <ruby><rb>双闪光</rb><rp>（</rp><rt>Double Shine</rt><rp>）</rp></ruby> 甚至无限闪光了解一下。</p><ul><li>虚假的电子竞技：「运营」40 分钟，一波推平。（搁这下棋呢？）</li><li>真正的电子竞技：1 帧决胜负。不是最后定输赢的 1 帧，是你操作的 <strong>每 1 帧</strong>。</li></ul><p>扯远了，话说回来，这里的设计并不全是为了所谓「手感」，甚至不是主要目的。<br>主要目的是为了游戏的「仿真」程度。</p><p>一个游戏拥有逼真的物理引擎是很有必要的，因为当没有人能够预料到的意外发生之时，你作为游戏制作者唯一能够指望的就是程序本身的健壮性，你不可能飞到玩家家里抢下手柄现修 bug。<br>只要拟真程度足够高，哪怕游戏出现了意外，最后产生的效果也会在人类的理解范围内，能够继续正常游玩；在机缘巧合之下甚至可能反过来增加游戏性，变成游戏的一部分。</p><p>而且扩展性强对后续的开发复用也很有好处。<br>比如我要做一个沼泽地形，在上面走会减速，怎么想都要侵入原本的移动系统，该如何设计呢？<br>打好了基础，我连一行代码都不用改，把对应的摩擦力数值调高就是了。<br>某种程度上不能说是功在千秋，也可以说一劳永逸了。</p><h2 id=给角色添加碰撞体以及-ysort-自动排序><a href=#给角色添加碰撞体以及-ysort-自动排序 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:给角色添加碰撞体以及-ysort-自动排序 class=headings>给角色添加碰撞体以及 YSort 自动排序</a></h2><p>一个角色有形象、能运动，就够了吗？当然不。游戏是用来玩的，不是用来看的。<br>所以我们需要碰撞体，来和环境乃至其他一切物体产生「交互」。</p><ol><li>给 <code>Player</code> 添加子节点 <code>CollisionShape2D</code>（碰撞形状）。</li><li>设置项的 <code>Shape</code> 选择 <code>New CapsuleShape2D</code>（胶囊状），这个形状的好处是碰到拐角等犄角旮旯的时候更容易转向，而不是被卡住动弹不得。</li><li>同样给别的实体也加上碰撞体，树啊灌木啊之类的，然后就可以产生碰撞了。</li><li>此时发现两个实体重叠时显示的优先级是节点的排序决定的，这显然不合理。<br>（显示角色会浮在树叶上或者被压在树干下。）</li><li>添加 <code>YSort</code> 节点（我命名为 <code>Entities</code>），直接把所有实体都丢到里面，现在可以发现自动排序了。需要注意 <code>YSort</code> 是根据节点的「原点」来排序的，所以记得调整好 Sprite、碰撞体、阴影等节点本身的相对位置，避免仍然显示异常。</li></ol><h2 id=给角色添加动作动画><a href=#给角色添加动作动画 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:给角色添加动作动画 class=headings>给角色添加动作动画</a></h2><ol><li>添加子节点 <code>AnimationPlayer</code> 插帧完成各向动画。</li><li>添加子节点 <code>AnimationTree</code>，右键「Add BlendSpace2D」，点击编辑进入<ruby><rb>座标视图</rb><rp>（</rp><rt>Blend Space</rt><rp>）</rp></ruby>。</li><li>点击第三个按钮「Create Points.」，分别在四个顶点（注意 Y 轴正方向是下，反过来的）添加动画，并把<ruby><rb>混合</rb><rp>（</rp><rt>Blend</rt><rp>）</rp></ruby>模式改成虚线（否则会鬼畜）。虚线代表不同状态之间的过渡是离散的，如果是骨骼动画才是用实线（自动补间完成关键帧之间的平滑过渡）。</li><li>并将 y 方向的正负上限设置为 <code>±1.1</code>，调整顶点形成新的三角，这样一来斜向移动就优先显示为横向了。因为面向落在三角里永远顶不满 y 轴，比如右上的矢量就会落在偏右的地方。</li><li>同样设置另一个，并将「Idle」和「Run」两个 Blend 节点连接起来，把「Idle」设置为自动播放，让动画树起始就处于 Idle 状态。</li></ol><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_animation_tree</span> <span class=o>=</span> <span class=o>$</span><span class=n>AnimationTree</span>  <span class=c1># 获取动画树</span>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_animation_state</span> <span class=o>=</span> <span class=n>_animation_tree</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;parameters/playback&#34;</span><span class=p>)</span>  <span class=c1># 获取动画树的状态机</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_move</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>face_aspect</span> <span class=o>==</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span>  <span class=c1># 被摩擦力逼停</span>
</span></span><span class=line><span class=cl>				<span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nb>clamp</span><span class=p>(</span><span class=n>friction</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=n>delta</span><span class=p>)</span>  <span class=c1># 物理帧补正卡顿</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>_animation_state</span><span class=o>.</span><span class=n>travel</span><span class=p>(</span><span class=s2>&#34;Idle&#34;</span><span class=p>)</span>  <span class=c1># 更新动画树的状态机 播放对应面向矢量方向的闲置动画</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span>  <span class=c1># 克服摩擦力做功</span>
</span></span><span class=line><span class=cl>				<span class=bp>self</span><span class=o>.</span><span class=n>face_aspect</span> <span class=o>*</span> <span class=n>max_speed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nb>clamp</span><span class=p>(</span><span class=n>acceleration</span> <span class=o>-</span> <span class=n>friction</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=n>delta</span><span class=p>)</span>  <span class=c1># 不能为负导致反向加速</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>_animation_tree</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=s2>&#34;parameters/Run/blend_position&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>face_aspect</span><span class=p>)</span>  <span class=c1># 将移动方向的混合座标设置为面向矢量</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>_animation_tree</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=s2>&#34;parameters/Idle/blend_position&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>face_aspect</span><span class=p>)</span>  <span class=c1># 同步闲置时的面向 确保停下来时不会突然转身</span>
</span></span><span class=line><span class=cl>		<span class=bp>self</span><span class=o>.</span><span class=n>_animation_state</span><span class=o>.</span><span class=n>travel</span><span class=p>(</span><span class=s2>&#34;Run&#34;</span><span class=p>)</span>  <span class=c1># 更新动画树的状态机 播放对应面向矢量方向的奔跑动画</span>
</span></span><span class=line><span class=cl>	<span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span> <span class=o>=</span> <span class=n>move_and_slide</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span><span class=p>)</span>  <span class=c1># 自动处理物理帧补正卡顿</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=设置游戏背景图像><a href=#设置游戏背景图像 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:设置游戏背景图像 class=headings>设置游戏背景图像</a></h2><ol><li>可以标准方案 <code>Sprite</code> 节点启用 <code>Region</code> 设置，导入素材时启用 <code>Repeat</code>。</li><li>也可以利用 <code>TextureRect</code> 节点设置<ruby><rb>拉伸模式</rb><rp>（</rp><rt>Stretch Mode</rt><rp>）</rp></ruby>为 <code>Tile</code> 自动填充，比 <code>Sprite</code> 节点必须手动调整尺寸方便一点。不过问题在于 <code>TextureRect</code> 节点是 <code>Control</code> 节点的子节点，也就是说它本质上是一个 UI 节点，不应该被当作背景使用。</li><li>建议使用第一种方法，以免以后出现莫名其妙的显示错位问题。<del>多改两个数字累不死</del></li></ol><h2 id=利用-tilemap-节点自动铺砖><a href=#利用-tilemap-节点自动铺砖 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:利用-tilemap-节点自动铺砖 class=headings>利用 TileMap 节点自动铺砖</a></h2><ol><li>在游戏关卡场景新建 <code>TileMap</code> 子节点，「New TileSet」，导入素材 <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>[1]</a></sup>。</li><li>「Edit」素材，随便拉一个区域（然后才会出现进一步的选项），启用<ruby><rb>对齐</rb><rp>（</rp><rt>Snap</rt><rp>）</rp></ruby>按钮，把 <code>Snap Options</code> 的<ruby><rb>步长</rb><rp>（</rp><rt>Step</rt><rp>）</rp></ruby>改为 <code>16 × 16</code>，现在可以重新选定区域了，把所有图块都包含进来。</li><li>设定 <code>Autotile Bitmask Mode</code> 设置为 <code>3×3 (minimal)</code>，<code>Subtile Size</code> 也改为 <code>16 × 16</code>，然后就可以画 <ruby><rb>位掩码</rb><rp>（</rp><rt>Bitmask</rt><rp>）</rp></ruby> 了。</li></ol><p><img src=https://s2.loli.net/2022/04/10/cF3E2QujLUA5YdC.png alt></p><p>原理很简单，就是一个九宫格，除开自己不是有 8 个方向的「邻居」嘛；<br>根据哪些方位有邻居，哪些方位没有，来判断合适的对应图样（以自动完成无缝拼接）。<br>更详细的原理可以参考《<a href=https://gamedevelopment.tutsplus.com/tutorials/how-to-use-tile-bitmasking-to-auto-tile-your-level-layouts--cms-25673 target=_blank rel=noopener>How to Use Tile Bitmasking to Auto-Tile Your Level Layouts</a>》这篇文章以及官方文档《<a href=https://docs.godotengine.org/en/stable/tutorials/2d/using_tilemaps.html target=_blank rel=noopener>Using TileMaps</a>》。（实在看得眼花照着上图抄作业就是了。）</p><p>至于 <code>Name</code> 和 <code>Icon</code> 无所谓，可以改成自己喜欢的。<br>切换回关卡场景，选中设定好的 TileMap 就可以快速设计关卡（画地图）了。<br>（和画 Bitmask 一样左键画右键擦。）</p><blockquote><p>技术的进步啊。想当年前辈们完成这一步，每一格都要肉眼认、手动选……</p></blockquote><p>说到 TileMap，其实目前的功能还非常有限，4.0 原生支持将场景作为 tile，到时候就起飞了。<br>其实现在（Godot 3.4）也可以，详见《<a href=/tech/game-godot-trick-instance-tilemap/ target=_blank>Godot 3.4 使用 TileMap 实例化场景</a>》。</p><h2 id=给-tilemap-添加碰撞体><a href=#给-tilemap-添加碰撞体 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:给-tilemap-添加碰撞体 class=headings>给 TileMap 添加碰撞体</a></h2><ol><li>故技重施，将悬崖也设置为 Autotile，注意悬崖的图片要大一点，<code>TileMap</code> 节点 <code>Cell</code> 设置项的 <code>Size</code> 和里面 <code>TileSet</code> 的 <code>Subtile Size</code> 都是 <code>32 × 32</code>。</li><li>掩码不需要重画一遍，画好的 Bitmask 是可以复制（Copy bitmask.）和粘贴的。</li><li>搞定掩码之后按下 <kbd>2</kbd> 切换到 <ruby><rb>碰撞体</rb><rp>（</rp><rt>Collision</rt><rp>）</rp></ruby> 设置，给 Autotile 添加碰撞体积。</li><li>这里操作有点繁琐，必须一个一个单独设置，最快的操作是：<ol><li>左键点击选中方格；</li><li><kbd>Shift</kbd>+<kbd>R</kbd> 添加新矩形；</li><li>再次左键点击放下矩形。</li></ol></li><li>现在用 Aututile 铺好的悬崖就有碰撞体积了（作为墙使用）。</li></ol><h2 id=区域检测hitbox--hurtbox><a href=#区域检测hitbox--hurtbox class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:区域检测hitbox--hurtbox class=headings>区域检测（Hitbox & Hurtbox）</a></h2><ol><li>新建一个场景，添加 <code>Area2D</code> 节点，添加 <code>CollisionShape2D</code> 子节点，保存为单独的场景 <ruby><rb>Hitbox</rb><rp>（</rp><rt>伤害判定框</rt><rp>）</rp></ruby>，<ruby><rb>Huttbox</rb><rp>（</rp><rt>受伤害检测框</rt><rp>）</rp></ruby> 如法炮制。<br>故意不给 <code>CollisionShape2D</code> 子节点添加形状是为了将这两个通用类抽象出来，便于复用。</li><li>新建一个草的场景，「<ruby><rb>Instance Child Scene</rb><rp>（</rp><rt>实例化子场景</rt><rp>）</rp></ruby>」选择保存的 <code>Hurtbox</code> 场景文件。</li><li>右键勾选「<ruby><rb>Editable Children</rb><rp>（</rp><rt>可编辑子节点</rt><rp>）</rp></ruby>」，这样就给草自定义了专属的 Hurtbox。</li><li>给角色添加一个 <code>Position2D</code> 子节点（我命名为 <code>Barycenter</code>），给 <code>Barycenter</code> 节点实例化一个 Hitbox。调整 <code>Barycenter</code> 的位置，这样攻击的判定才根据角色的中心对称。</li><li>回到动画播放器，给 <code>Barycenter</code> 添加 <code>Rotation Degree</code> 的关键帧，让重心面向跟随攻击动画方向旋转。</li><li>继续给 Hitbox 具体<strong>形状</strong>的 <code>Disable</code> 添加关键帧。攻击动画有 4 帧，想让中间 2 帧有攻击判定，那么就要让动画在第 2 帧开始时取消禁用，第 4 帧开始时勾选禁用。<br>平时就把 Hitbox 禁用掉，只有做出攻击动作的时候才会出现攻击判定框。</li><li>然后是 Collision <code>Layer</code> / <code>Mask</code> 的设置。Godot 默认设置都是同一层（即第 1 层），这是为了在游戏没有做更多额外设置的时候生效，实际上是不合理的。<br>你可以想象一对发送者和接收者，是把自己的位置信息发送给对方。<br>（默认是众生平等一律视为同一种东西，自己发送给自己，因此一切碰撞都会相互影响。）<br>更通俗一点也可以用本哥视频里的说法：你是「坐在」Layer 层，然后「面对」Mask 层。</li></ol><div class=table-container><table><thead><tr><th style=text-align:left>Layer</th><th style=text-align:left></th><th style=text-align:left></th><th style=text-align:left></th></tr></thead><tbody><tr><td style=text-align:left><code>#1</code> World</td><td style=text-align:left><code>#2</code> Player</td><td style=text-align:left><code>#3</code> Enemy</td><td style=text-align:left><code>#4</code></td></tr><tr><td style=text-align:left><code>#5</code></td><td style=text-align:left><code>#6</code> PlayerHurtbox</td><td style=text-align:left><code>#7</code> EnemyHurtbox</td><td style=text-align:left><code>#8</code></td></tr></tbody></table></div><div class=table-container><table><thead><tr><th style=text-align:left>Mask</th><th style=text-align:left></th><th style=text-align:left></th><th style=text-align:left></th></tr></thead><tbody><tr><td style=text-align:left><code>#1</code> World</td><td style=text-align:left><code>#2</code> Player</td><td style=text-align:left><code>#3</code> Enemy</td><td style=text-align:left><code>#4</code></td></tr><tr><td style=text-align:left><code>#5</code></td><td style=text-align:left><code>#6</code> PlayerHurtbox</td><td style=text-align:left><code>#7</code> EnemyHurtbox</td><td style=text-align:left><code>#8</code></td></tr></tbody></table></div><p>可以在项目设置的「2d Physics」设置项里命名，重新项目生效。</p><div class=table-container><table><thead><tr><th style=text-align:center>物体</th><th style=text-align:center>Layer</th><th style=text-align:center>Mask</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center>悬崖、灌木等环境实体</td><td style=text-align:center><code>World</code></td><td style=text-align:center></td><td style=text-align:center>没有任何 Mask<br>它们都是死物，不会主动去找谁互动</td></tr><tr><td style=text-align:center>可破坏的罐子</td><td style=text-align:center><code>World</code><br><code>EnemyHurtbox</code></td><td style=text-align:center></td><td style=text-align:center>它既是实体，可以和其他实体产生碰撞<br>同时可以视为一个「不会动的敌人」</td></tr><tr><td style=text-align:center>可破坏的草丛</td><td style=text-align:center><code>EnemyHurtbox</code></td><td style=text-align:center></td><td style=text-align:center>相当于没有实体的罐子</td></tr><tr><td style=text-align:center>玩家</td><td style=text-align:center><code>Player</code><br><code>PlayerHurtbox</code></td><td style=text-align:center><code>World</code><br><code>EnemyHurtbox</code></td><td style=text-align:center>具有和环境发生互动的主观能动性<br>因此会和 <code>World</code> 层产生碰撞<br>还会对敌人造成伤害<br>其实 Mask 可以加上 <code>Enemy</code><br>这样敌人就会和玩家产生体积碰撞<br>可以根据设计选择是否能卡住玩家</td></tr><tr><td style=text-align:center>敌人</td><td style=text-align:center><code>Enemy</code><br><code>EnemyHurtbox</code></td><td style=text-align:center><code>World</code><br><code>PlayerHurtbox</code></td><td style=text-align:center>原理同上</td></tr></tbody></table></div><p>举个例子，比如单独把玩家抽出来看就是：</p><ul><li>会和悬崖、墙壁、树木、灌木等环境产生碰撞，但会穿过草丛、敌人、其他玩家；<br>（网游里考虑到同屏单位数量一般都是可以穿怪穿人的，单机讲究身位的话一般不能。）</li><li>攻击会对罐子、草丛、敌人生效；</li><li>会受到敌人的攻击。</li><li>玩家和敌人不会互相碰撞，但却都会被环境的实体阻挡。</li></ul><p>非常简单易懂。</p><p>至于 <code>Player</code>、<code>Enemy</code> 分别和自己的 <code>Hurtbox</code> 分开也是有必要的。<br>比如一位长腿的大<del>姐姐</del> 蜘蛛，打腿可能不算做伤害（攻击判定没有进 Hurtbox），但讲究的游戏（追求不穿模）就会做模型修正让腿无法穿过地面（做出自动屈膝之类的动作来贴合地面）。<br>或者说一个穿披风的角色——披风一般是有布料演算的，不会直接穿过身体——但披风飘在空中被打到显然不能算伤害，否则就太不合理了。</p><h2 id=击退效果和伤害属性><a href=#击退效果和伤害属性 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:击退效果和伤害属性 class=headings>击退效果和伤害属性</a></h2><p><code>area_entered</code> 这个信号传递的参数 <code>area</code> 是整个 <code>Area2D</code> 节点对象，在里面写什么属性都可以。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># player.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>KinematicBody2D</span>
</span></span><span class=line><span class=cl><span class=c1># 玩家的主脚本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_move</span><span class=p>(</span><span class=n>delta</span><span class=p>:</span> <span class=ne>float</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=c1># 前略</span>
</span></span><span class=line><span class=cl>	<span class=o>$</span><span class=n>Hitbox</span><span class=o>.</span><span class=n>knockback_vector</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>move_vector</span>  <span class=c1># 击退方向与面向同步</span>
</span></span><span class=line><span class=cl>	<span class=c1># 后略</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># sword_hitbox.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>Area2D</span>
</span></span><span class=line><span class=cl><span class=c1># 玩家的 Hitbox (可以视为武器属性)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>knockback_power</span><span class=p>:</span> <span class=ne>float</span> <span class=o>=</span> <span class=mf>20.0</span>  <span class=c1># 击退力</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>damage</span><span class=p>:</span> <span class=ne>float</span> <span class=o>=</span> <span class=mf>1.0</span>  <span class=c1># 伤害</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>knockback_vector</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span> <span class=k>setget</span> <span class=n>set_knockback</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 归一(标准)化击退效果</span>
</span></span><span class=line><span class=cl><span class=c1># 当然也可以不做 那样就是把移动速度也加成进击退效果 也说得通</span>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>set_knockback</span><span class=p>(</span><span class=n>aspect</span><span class=p>:</span> <span class=ne>Vector2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>knockback_vector</span> <span class=o>=</span> <span class=n>aspect</span><span class=o>.</span><span class=n>normalized</span><span class=p>()</span> <span class=o>*</span> <span class=n>knockback_power</span> <span class=o>*</span> <span class=mi>10</span>
</span></span></code></pre></td></tr></table></div></div></div><p>然后 <code>area_entered</code> 信号的回调函数 <code>_on_area_entered(area)</code> 的参数就是 <code>sword_hitbox.gd</code> 这个脚本（<ruby><rb>附着</rb><rp>（</rp><rt>attach</rt><rp>）</rp></ruby>的节点）。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># enemy.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>KinematicBody2D</span>
</span></span><span class=line><span class=cl><span class=c1># 敌人的主脚本 不过单独写在hurtbox的脚本也可以</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>air_friction</span> <span class=o>=</span> <span class=mf>10.0</span>  <span class=c1># 空气摩擦力</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>_knockback</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>_health</span> <span class=o>=</span> <span class=mf>2.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>_knockback</span> <span class=o>=</span> <span class=n>_knockback</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span>  <span class=c1># 被摩擦力逼停</span>
</span></span><span class=line><span class=cl>			<span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nb>max</span><span class=p>(</span><span class=n>air_friction</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)</span> <span class=o>*</span> <span class=n>delta</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>  <span class=c1># 物理帧补正卡顿</span>
</span></span><span class=line><span class=cl>	<span class=n>_knockback</span> <span class=o>=</span> <span class=n>move_and_slide</span><span class=p>(</span><span class=n>_knockback</span><span class=p>)</span>  <span class=c1># 处理击退力(被击退)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_on_area_entered</span><span class=p>(</span><span class=n>sword_hitbox</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=bp>self</span><span class=o>.</span><span class=n>_knockback</span> <span class=o>=</span> <span class=n>sword_hitbox</span><span class=o>.</span><span class=n>knockback_vector</span>  <span class=c1># 获取击退力并应用</span>
</span></span><span class=line><span class=cl>	<span class=bp>self</span><span class=o>.</span><span class=n>_health</span> <span class=o>-=</span> <span class=n>sword_hitbox</span><span class=o>.</span><span class=n>damage</span>  <span class=c1># 获取伤害并应用</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=抽象出特效动画><a href=#抽象出特效动画 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:抽象出特效动画 class=headings>抽象出特效动画</a></h2><p>如果不同敌人具有不同的消失特效，每次都要重写一遍动画脚本就很麻烦。<br>因此可以把针对性的特定脚本抽象成通用的脚本。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># hit_effect.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>AnimatedSprite</span>
</span></span><span class=line><span class=cl><span class=c1># 受击特效动画</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_ready</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>err</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;animation_finished&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;_on_animation_finished&#34;</span><span class=p>)</span>  <span class=c1># 连接信号</span>
</span></span><span class=line><span class=cl>	<span class=nb>assert</span><span class=p>(</span><span class=n>err</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># 断言没有错误</span>
</span></span><span class=line><span class=cl>	<span class=n>play</span><span class=p>(</span><span class=s2>&#34;default&#34;</span><span class=p>)</span>  <span class=c1># 播放默认的动画(受击特效)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_on_animation_finished</span><span class=p>():</span>  <span class=c1># 信号回调函数</span>
</span></span><span class=line><span class=cl>	<span class=n>queue_free</span><span class=p>()</span>  <span class=c1># 当动画播放完毕之后释放自己</span>
</span></span></code></pre></td></tr></table></div></div></div><p>接着建立对应的 <code>AnimatedSprite</code> 动画节点，应用素材（帧动画），保存为单独的场景（假设为 <code>grass_effect.tscn</code>），直接把以上的脚本附上，之后主脚本直接实例化「特效场景」即可。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># grass.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>Node2D</span>
</span></span><span class=line><span class=cl><span class=c1># 草的主脚本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>GRASS_EFFECT</span> <span class=o>=</span> <span class=nb>preload</span><span class=p>(</span><span class=s2>&#34;res://src/models/grass_effect.tscn&#34;</span><span class=p>)</span>  <span class=c1># 预加载特效动画场景</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_play_vanish_animation</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>grass_effect</span> <span class=o>=</span> <span class=n>GRASS_EFFECT</span><span class=o>.</span><span class=n>instance</span><span class=p>()</span>  <span class=c1># 实例化特效动画场景</span>
</span></span><span class=line><span class=cl>	<span class=n>get_parent</span><span class=p>()</span><span class=o>.</span><span class=n>add_child</span><span class=p>(</span><span class=n>grass_effect</span><span class=p>)</span>  <span class=c1># 将特效动画添加为兄弟节点</span>
</span></span><span class=line><span class=cl>	<span class=c1># 添加为兄弟节点 而不是根节点(get_tree)的子节点 有一个好处:</span>
</span></span><span class=line><span class=cl>	<span class=c1># 草场景的父节点是YSort(自动排序)节点 这样一来动画也会自动应用排序效果</span>
</span></span><span class=line><span class=cl>	<span class=n>grass_effect</span><span class=o>.</span><span class=n>global_position</span> <span class=o>=</span> <span class=n>global_position</span>  <span class=c1># 修正动画的播放位置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_on_Hurtbox_area_entered</span><span class=p>(</span><span class=n>_area</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>_play_vanish_animation</span><span class=p>()</span>  <span class=c1># 播放动画</span>
</span></span><span class=line><span class=cl>	<span class=c1># 由于动画是单独的场景 播放完毕会释放它自己(占用的内存) 所以不用管了</span>
</span></span><span class=line><span class=cl>	<span class=n>queue_free</span><span class=p>()</span>  <span class=c1># 释放自己(草本身)就完事</span>
</span></span><span class=line><span class=cl>	<span class=c1># 如果有血量(不是草而是其他敌人) 一次打不死 也是在这里加判定</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=小怪-ai索敌><a href=#小怪-ai索敌 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:小怪-ai索敌 class=headings>小怪 AI：索敌</a></h2><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># player_detection.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>Area2D</span>
</span></span><span class=line><span class=cl><span class=c1># 玩家检测节点的脚本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>player</span> <span class=o>=</span> <span class=n>null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>can_see_player</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=ne>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>player</span> <span class=o>!=</span> <span class=n>null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_on_PlayerDetectionZone_body_entered</span><span class=p>(</span><span class=n>body</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>player</span> <span class=o>=</span> <span class=n>body</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_on_PlayerDetectionZone_body_exited</span><span class=p>(</span><span class=n>_body</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>player</span> <span class=o>=</span> <span class=n>null</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># enemy.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>KinematicBody2D</span>
</span></span><span class=line><span class=cl><span class=c1># 敌人主脚本 与本节无关的内容已酌情删减</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>enum</span> <span class=p>{</span> <span class=n>IDLE</span><span class=p>,</span> <span class=n>WANDER</span><span class=p>,</span> <span class=n>CHASE</span> <span class=p>}</span>  <span class=c1># 枚举状态自动机所有状态</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>max_speed</span> <span class=o>=</span> <span class=mf>60.0</span>  <span class=c1># 移速上限</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>acceleration</span> <span class=o>=</span> <span class=mf>50.0</span>  <span class=c1># 加速度</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>friction</span> <span class=o>=</span> <span class=mf>40.0</span>  <span class=c1># 环境摩擦力</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>air_friction</span> <span class=o>=</span> <span class=mf>10.0</span>  <span class=c1># 空气摩擦力</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>_move_vector</span><span class=p>:</span> <span class=ne>Vector2</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>  <span class=c1># 移动矢量</span>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>_knockback</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>  <span class=c1># 击退矢量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_action_state</span> <span class=o>=</span> <span class=n>IDLE</span>  <span class=c1># 记录状态机的状态</span>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_sprite</span> <span class=o>=</span> <span class=o>$</span><span class=ne>AnimatedSprite</span>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_player_detection</span> <span class=o>=</span> <span class=o>$</span><span class=n>PlayerDetectionZone</span>  <span class=c1># 索敌范围(检测玩家用的 Area2D 节点)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>_knockback</span> <span class=o>=</span> <span class=n>_knockback</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span><span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>,</span>  <span class=c1># 被摩擦力逼停</span>
</span></span><span class=line><span class=cl>			<span class=nb>max</span><span class=p>(</span><span class=n>air_friction</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)</span> <span class=o>*</span> <span class=n>delta</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>  <span class=c1># 物理帧补正卡顿</span>
</span></span><span class=line><span class=cl>	<span class=n>_knockback</span> <span class=o>=</span> <span class=n>move_and_slide</span><span class=p>(</span><span class=n>_knockback</span><span class=p>)</span>  <span class=c1># 处理击退</span>
</span></span><span class=line><span class=cl>	<span class=n>match</span> <span class=bp>self</span><span class=o>.</span><span class=n>_action_state</span><span class=p>:</span>  <span class=c1># 简易状态机</span>
</span></span><span class=line><span class=cl>		<span class=n>CHASE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>do_chase</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>  <span class=c1># 追逐</span>
</span></span><span class=line><span class=cl>		<span class=n>WANDER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>do_wander</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>  <span class=c1># 游荡</span>
</span></span><span class=line><span class=cl>		<span class=n>IDLE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>do_idle</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>  <span class=c1># 闲置</span>
</span></span><span class=line><span class=cl>	<span class=n>_move_vector</span> <span class=o>=</span> <span class=n>move_and_slide</span><span class=p>(</span><span class=n>_move_vector</span><span class=p>)</span>  <span class=c1># 处理移动</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>move_to_point</span><span class=p>(</span><span class=n>point_position</span><span class=p>:</span> <span class=ne>Vector2</span><span class=p>,</span> <span class=n>delta</span><span class=p>:</span> <span class=ne>float</span><span class=p>):</span>  <span class=c1># 移动到指定地点</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>face_vector</span><span class=p>:</span> <span class=ne>Vector2</span> <span class=o>=</span> <span class=n>global_position</span><span class=o>.</span><span class=n>direction_to</span><span class=p>(</span><span class=n>point_position</span><span class=p>)</span><span class=o>.</span><span class=n>normalized</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=n>_move_vector</span> <span class=o>=</span> <span class=n>_move_vector</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span><span class=n>face_vector</span> <span class=o>*</span> <span class=n>max_speed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nb>clamp</span><span class=p>(</span><span class=n>acceleration</span> <span class=o>-</span> <span class=n>friction</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=n>max_speed</span><span class=p>)</span> <span class=o>*</span> <span class=n>delta</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>_sprite</span><span class=o>.</span><span class=n>flip_h</span> <span class=o>=</span> <span class=n>_move_vector</span><span class=o>.</span><span class=n>x</span> <span class=o>&lt;</span> <span class=mi>0</span>  <span class=c1># 调整面向</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>alert_around</span><span class=p>():</span>  <span class=c1># 巡视四周(游荡还没做 因此目前只有单纯的警戒功能)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>_player_detection</span><span class=o>.</span><span class=n>can_see_player</span><span class=p>():</span>  <span class=c1># 检测到玩家</span>
</span></span><span class=line><span class=cl>		<span class=n>_action_state</span> <span class=o>=</span> <span class=n>CHASE</span>  <span class=c1># 开始追逐玩家</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_chase</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>player</span> <span class=o>=</span> <span class=n>_player_detection</span><span class=o>.</span><span class=n>player</span>  <span class=c1># 尝试获取玩家节点</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>player</span> <span class=o>!=</span> <span class=n>null</span><span class=p>:</span>  <span class=c1># 检测到玩家存在</span>
</span></span><span class=line><span class=cl>		<span class=n>move_to_point</span><span class=p>(</span><span class=n>player</span><span class=o>.</span><span class=n>global_position</span><span class=p>,</span> <span class=n>delta</span><span class=p>)</span>  <span class=c1># 朝玩家所在地点移动</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>_action_state</span> <span class=o>=</span> <span class=n>IDLE</span>  <span class=c1># 丢失追逐目标 继续闲置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_wander</span><span class=p>(</span><span class=n>_delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=c1># TODO 游荡功能还没做</span>
</span></span><span class=line><span class=cl>	<span class=n>alert_around</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_idle</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>_move_vector</span> <span class=o>=</span> <span class=n>_move_vector</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span><span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nb>max</span><span class=p>(</span><span class=n>friction</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)</span> <span class=o>*</span> <span class=n>delta</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>_move_vector</span> <span class=o>=</span> <span class=n>move_and_slide</span><span class=p>(</span><span class=n>_move_vector</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>alert_around</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=添加无敌帧避免短时间内被大量判定伤害次数><a href=#添加无敌帧避免短时间内被大量判定伤害次数 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:添加无敌帧避免短时间内被大量判定伤害次数 class=headings>添加无敌帧（避免短时间内被大量判定伤害次数）</a></h2><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># hurtbox.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>Area2D</span>
</span></span><span class=line><span class=cl><span class=c1># Hurtbox 通用脚本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>signal</span> <span class=n>invincibility_started</span><span class=p>(</span><span class=n>visibility</span><span class=p>)</span>  <span class=c1># 无敌帧开始信号(参数是预留给以后做凸显无敌帧特效的)</span>
</span></span><span class=line><span class=cl><span class=k>signal</span> <span class=n>invincibility_ended</span>  <span class=c1># 无敌帧结束信号</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>_invincible</span><span class=p>:</span> <span class=ne>bool</span> <span class=o>=</span> <span class=bp>false</span> <span class=k>setget</span> <span class=n>set_invincible</span>  <span class=c1># 无敌帧</span>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>_visibility</span><span class=p>:</span> <span class=ne>bool</span> <span class=o>=</span> <span class=bp>false</span>  <span class=c1># 无敌帧可见状态</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_collision</span> <span class=o>=</span> <span class=o>$</span><span class=ne>CollisionShape2D</span>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_timer</span> <span class=o>=</span> <span class=o>$</span><span class=ne>Timer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>start_invincibility</span><span class=p>(</span><span class=n>duration</span><span class=p>:</span> <span class=ne>float</span><span class=p>,</span> <span class=n>enable_blink</span><span class=p>:</span> <span class=ne>bool</span> <span class=o>=</span> <span class=bp>false</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>_visibility</span> <span class=o>=</span> <span class=n>enable_blink</span>  <span class=c1># TODO 特效暂未显示</span>
</span></span><span class=line><span class=cl>	<span class=bp>self</span><span class=o>.</span><span class=n>_invincible</span> <span class=o>=</span> <span class=bp>true</span>  <span class=c1># 启用无敌帧</span>
</span></span><span class=line><span class=cl>	<span class=n>_timer</span><span class=o>.</span><span class=n>start</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>  <span class=c1># 开始无敌帧倒计时</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>set_invincible</span><span class=p>(</span><span class=n>is_invincible</span><span class=p>:</span> <span class=ne>bool</span><span class=p>):</span>  <span class=c1># 根据新的无敌帧状态触发对应信号</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>is_invincible</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>emit_signal</span><span class=p>(</span><span class=s2>&#34;invincibility_started&#34;</span><span class=p>,</span> <span class=n>_visibility</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>emit_signal</span><span class=p>(</span><span class=s2>&#34;invincibility_ended&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_on_Hurtbox_invincibility_started</span><span class=p>(</span><span class=n>_visibility</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>_collision</span><span class=o>.</span><span class=n>set_deferred</span><span class=p>(</span><span class=s2>&#34;disabled&#34;</span><span class=p>,</span> <span class=bp>true</span><span class=p>)</span> <span class=c1># 禁用受击碰撞箱(实质性无敌)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_on_Hurtbox_invincibility_ended</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=n>_collision</span><span class=o>.</span><span class=n>disabled</span> <span class=o>=</span> <span class=bp>false</span> <span class=c1># 重新启用受击碰撞箱(取消无敌)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_on_Timer_timeout</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=bp>self</span><span class=o>.</span><span class=n>_invincible</span> <span class=o>=</span> <span class=bp>false</span>  <span class=c1># 无敌帧结束 触发信号</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=血量显示><a href=#血量显示 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:血量显示 class=headings>血量显示</a></h2><p>实在没什么可说的，值得一提的就一个小知识点：<br>勾选（启用）<code>TextureRect</code> 节点的 <code>Expand</code> 配置项之后，尺寸（<code>Rect</code> 的 <code>Size</code>）才能小于材质素材本身的大小，否则节点的尺寸会被自动撑到材质本身的尺寸。</p><p>注意是紧挨着材质（<code>Texture</code>）下面的 <code>Expand</code>；<br>不是 <code>Control</code> 节点通用配置里的 Size Flags > Horizontal / Vertical > Expand 这个同名设置。</p><h2 id=敌人之间的软碰撞伪物理><a href=#敌人之间的软碰撞伪物理 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:敌人之间的软碰撞伪物理 class=headings>敌人之间的软碰撞（伪物理）</a></h2><p>目前的敌人之间也是没有碰撞体积的，本来就这样也没什么问题。<br>可是稍微溜一溜两个敌人就会完全重合在一起，看起来只有一个敌人，这就影响游戏体验了。</p><p>解决方案不是让敌人之间进行碰撞判定，会带来大量计算负担，表现效果也不好（互相卡住）。<br>而是再加一个特殊的碰撞体：它本身同样没有体积判定，但当碰撞发生时会给双方一个反向的移动矢量，来模拟碰撞的物理效果。这个向量不用太大，能阻止多个敌人叠在一起就够了。</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># soft_collision.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>Area2D</span>
</span></span><span class=line><span class=cl><span class=c1># 软碰撞脚本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>is_colliding</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=ne>bool</span><span class=p>:</span>  <span class=c1># 判定是否发生碰撞</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>get_overlapping_areas</span><span class=p>()</span><span class=o>.</span><span class=n>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span>  <span class=c1># 存在重叠的区域 = 发生碰撞</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>gen_push_vector</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=ne>Vector2</span><span class=p>:</span>  <span class=c1># 生成推开的移动向量</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>is_colliding</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=k>var</span> <span class=n>areas</span> <span class=o>=</span> <span class=n>get_overlapping_areas</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>var</span> <span class=n>push_vector</span> <span class=o>=</span> <span class=n>areas</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>global_position</span><span class=o>.</span><span class=n>direction_to</span><span class=p>(</span><span class=n>global_position</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1># areas[0]: 由于碰撞双方都会进行判定 因此各管各的的就够了</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>push_vector</span><span class=o>.</span><span class=n>normalized</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># enemy.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>KinematicBody2D</span>
</span></span><span class=line><span class=cl><span class=c1># 敌人主脚本 与本节无关的内容已酌情删减</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_soft_collision</span> <span class=o>=</span> <span class=o>$</span><span class=n>SoftCollision</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_physics_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>_soft_collision</span><span class=o>.</span><span class=n>is_colliding</span><span class=p>():</span>  <span class=c1># 发生碰撞</span>
</span></span><span class=line><span class=cl>		<span class=n>_move_vector</span> <span class=o>+=</span> <span class=n>_soft_collision</span><span class=o>.</span><span class=n>gen_push_vector</span><span class=p>()</span> <span class=o>*</span> <span class=n>delta</span> <span class=o>*</span> <span class=mi>600</span>  <span class=c1># 推开自己</span>
</span></span><span class=line><span class=cl>		<span class=c1># 由于每个敌人都会同时推开自己 等于是互相推开了</span>
</span></span><span class=line><span class=cl>		<span class=c1># 类似车让人的同时人让车 结果双方都愣住了(还蛮尴尬的)</span>
</span></span><span class=line><span class=cl>	<span class=n>_move_vector</span> <span class=o>=</span> <span class=n>move_and_slide</span><span class=p>(</span><span class=n>_move_vector</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></div><p>当然，最后还要给软碰撞单独设置一层 <code>SoftCollision</code> 层：<br>它自己（Layer）是软碰撞体，它会与别的软碰撞体（Mask）发生碰撞。</p><blockquote><p>更好的办法是利用<a href=/tech/game-godot-review-1-prepare/#_processdelta-%E5%92%8C-_physics_processdelta-%E8%AF%A5%E7%94%A8%E5%93%AA%E4%B8%AA target=_blank>之前讲过的 Timer</a> 来定时检测，没必要每一帧都检测并处理碰撞。<br>不过示例的性能已经够用了，毕竟是 2D 游戏，还是实际分辨率压到 320 × 180 的低品质渲染。<br>如果是 3D 游戏、高品质三渲二（奥日 2）、涉及大数字的大量计算（暗黑 3 的范围伤）等等，只要存在性能问题就可以考虑诸如此类的细节优化了，最后的效果积少成多非常可观。<br>毕竟出现的性能问题本来就是这样聚沙成塔、集腋成裘，结果堆出来的。</p></blockquote><h2 id=镜头设置><a href=#镜头设置 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:镜头设置 class=headings>镜头设置</a></h2><p>最符合直觉的设计逻辑是将镜头设置在玩家节点里，这样镜头天然就跟随玩家。<br>不过如此一来会出现一些——诸如血量等 GUI 无法跟随镜头（HUD 不跟随镜头留在环境里也太怪了），玩家死亡导致节点被释放后镜头也会被重置到初始位置……等等，奇怪的问题。<br>因此最好另辟蹊径：</p><ol><li>新建 <code>CanvasLayer</code> 节点，这个节点会与主世界（<code>Node2D</code> 节点）断开位置之间的联系，成为单独的一层，UI 相关的内容都应该放在里面。</li><li>镜头当然也算 UI，在 <code>CanvasLayer</code> 节点下添加 <code>Camera2D</code> 场景，勾选启用<ruby><rb>平滑镜头</rb><rp>（</rp><rt>Smoothing</rt><rp>）</rp></ruby>。</li><li>在玩家场景添加 <code>RemoteTransform2D</code> 子节点，<code>Remote Path</code> 设置为 <code>Camera2D</code> 镜头节点，这样镜头就会跟随玩家了。同时玩家死亡后镜头也会留在原地。</li><li>在镜头场景（<code>Camera2D</code> 节点）添加 <code>Node</code> 子节点，这个节点没有 <code>transform</code> 属性。<ol><li>也就是说，它的父节点的位置信息不会传给它的子节点。命名为 <code>SeparationNode</code>。</li><li>给 <code>SeparationNode</code> 添加两个 <code>Position2D</code> 子节点，用来定位限制镜头的极限边界，分别命名为 <code>LimitTopLeft</code> / <code>LimitBottomRight</code>。</li><li>添加对应脚本，以后移动两个 <code>Position2D</code> 子节点就可以可视化编辑镜头的边界了。</li></ol></li></ol><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># camera.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>Camera2D</span>
</span></span><span class=line><span class=cl><span class=c1># 镜头脚本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>top_left</span> <span class=o>=</span> <span class=o>$</span><span class=n>SeparationNode</span><span class=o>/</span><span class=n>LimitTopLeft</span>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>bottom_right</span> <span class=o>=</span> <span class=o>$</span><span class=n>SeparationNode</span><span class=o>/</span><span class=n>LimitBottomRight</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_ready</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=n>limit_top</span> <span class=o>=</span> <span class=n>top_left</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>y</span>
</span></span><span class=line><span class=cl>	<span class=n>limit_right</span> <span class=o>=</span> <span class=n>bottom_right</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span>
</span></span><span class=line><span class=cl>	<span class=n>limit_bottom</span> <span class=o>=</span> <span class=n>bottom_right</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>y</span>
</span></span><span class=line><span class=cl>	<span class=n>limit_left</span> <span class=o>=</span> <span class=n>top_left</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=小怪-ai巡逻游荡><a href=#小怪-ai巡逻游荡 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:小怪-ai巡逻游荡 class=headings>小怪 AI：巡逻（游荡）</a></h2><ol><li>每只小怪生成之时就记录自己的当前座标，标记为出生点。</li><li>在出生点附近（周围固定半径的一个圆，可以视为警戒区域）随机生成一个巡逻地点。</li><li>移动到巡逻地点之后站岗（闲置）一段时间，然后继续下一次巡逻（游荡）。</li><li>途中一旦发现玩家，就优先开始追逐玩家，直到玩家脱离视野或脱离仇恨范围。</li><li>追逐玩家 > 当前巡逻任务 > 下一次巡逻任务。</li></ol><p>这个机制的妙处在于天然存在回归机制：</p><ol><li>追逐玩家过程中丢失仇恨，立刻执行下一次巡逻任务（状态机切换为 <code>WANDER</code>）。</li><li>由于巡逻地点只会在出生点附近刷新，因此表现为「脱离仇恨后自动回到出生区域」。</li><li>缺点是实现过于简陋（没有导航系统），脱离仇恨之后是径直（直线路径）前往出生点。<br>也就是说，很容易被玩家利用地形卡住。当然了，<code>move_and_slide()</code> 以及 360 度的全向移动矢量（而不是仅玩家可输入的八向移动操作）还是存在一定容错性。</li></ol><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># wander_controller.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>Node2D</span>
</span></span><span class=line><span class=cl><span class=c1># 游荡控制器节点脚本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>int</span><span class=p>)</span> <span class=k>var</span> <span class=n>wander_range</span><span class=p>:</span> <span class=ne>float</span> <span class=o>=</span> <span class=mf>30.0</span>  <span class=c1># 巡逻范围</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>start_position</span><span class=p>:</span> <span class=ne>Vector2</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>target_position</span><span class=p>:</span> <span class=ne>Vector2</span> <span class=o>=</span> <span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>_wandering</span><span class=p>:</span> <span class=ne>bool</span> <span class=o>=</span> <span class=bp>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_alert_timer</span> <span class=o>=</span> <span class=o>$</span><span class=ne>Timer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_ready</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=n>start_position</span> <span class=o>=</span> <span class=n>global_position</span>  <span class=c1># 出生点位置</span>
</span></span><span class=line><span class=cl>	<span class=n>target_position</span> <span class=o>=</span> <span class=n>global_position</span>  <span class=c1># 下一次巡逻地点位置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>wandering</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=ne>bool</span><span class=p>:</span>  <span class=c1># 是否处于游荡(巡逻)状态</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>_wandering</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>alerting</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=ne>bool</span><span class=p>:</span>  <span class=c1># 是否处于警戒(站岗)状态</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=ow>not</span> <span class=n>_alert_timer</span><span class=o>.</span><span class=n>is_stopped</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>start_wander</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=n>_wandering</span> <span class=o>=</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>	<span class=n>_update_new_target</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;已更新新的巡逻地点 &#34;</span><span class=p>,</span> <span class=n>target_position</span><span class=p>,</span> <span class=s2>&#34; 开始巡逻&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>stop_wander</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=n>_wandering</span> <span class=o>=</span> <span class=bp>false</span>
</span></span><span class=line><span class=cl>	<span class=nb>print</span><span class=p>(</span><span class=s2>&#34;到达巡逻地点 终止巡逻&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>start_alert</span><span class=p>(</span><span class=n>duration</span><span class=p>:</span> <span class=ne>float</span> <span class=o>=</span> <span class=mf>3.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>_alert_timer</span><span class=o>.</span><span class=n>start</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_update_new_target</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>new_target</span> <span class=o>=</span> <span class=n>start_position</span> <span class=o>+</span> <span class=ne>Vector2</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=nb>rand_range</span><span class=p>(</span><span class=o>-</span><span class=n>wander_range</span><span class=p>,</span> <span class=n>wander_range</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nb>rand_range</span><span class=p>(</span><span class=o>-</span><span class=n>wander_range</span><span class=p>,</span> <span class=n>wander_range</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=c1># TODO 优化新巡逻地点的生成效率</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=n>new_target</span><span class=o>.</span><span class=n>distance_to</span><span class=p>(</span><span class=n>target_position</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>wander_range</span> <span class=o>/</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1># 避免生成的下一次巡逻地点过近</span>
</span></span><span class=line><span class=cl>		<span class=n>new_target</span> <span class=o>=</span> <span class=n>start_position</span> <span class=o>+</span> <span class=ne>Vector2</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=nb>rand_range</span><span class=p>(</span><span class=o>-</span><span class=n>wander_range</span><span class=p>,</span> <span class=n>wander_range</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nb>rand_range</span><span class=p>(</span><span class=o>-</span><span class=n>wander_range</span><span class=p>,</span> <span class=n>wander_range</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>target_position</span> <span class=o>=</span> <span class=n>new_target</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># enemy.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=ne>KinematicBody2D</span>
</span></span><span class=line><span class=cl><span class=c1># 敌人主脚本 与本节无关的内容已酌情删减</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>bool</span><span class=p>)</span> <span class=k>var</span> <span class=n>guard_mode</span><span class=p>:</span> <span class=ne>bool</span> <span class=o>=</span> <span class=bp>true</span>  <span class=c1># 守卫模式(追出太远放弃仇恨)</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>max_chase_range</span><span class=p>:</span> <span class=ne>float</span> <span class=o>=</span> <span class=mf>200.0</span>  <span class=c1># 最大仇恨范围</span>
</span></span><span class=line><span class=cl><span class=k>export</span><span class=p>(</span><span class=ne>float</span><span class=p>)</span> <span class=k>var</span> <span class=n>wander_initiative</span><span class=p>:</span> <span class=ne>float</span> <span class=o>=</span> <span class=mf>75.0</span>  <span class=c1># 游荡几率(巡逻的主动性)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>var</span> <span class=n>_keep_enmity</span><span class=p>:</span> <span class=ne>bool</span> <span class=o>=</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>onready</span> <span class=k>var</span> <span class=n>_wander_controller</span> <span class=o>=</span> <span class=o>$</span><span class=n>WanderController</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>alert_around</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>_player_detection</span><span class=o>.</span><span class=n>can_see_player</span><span class=p>():</span>  <span class=c1># 检测到玩家</span>
</span></span><span class=line><span class=cl>		<span class=n>_action_state</span> <span class=o>=</span> <span class=n>CHASE</span>  <span class=c1># 开始追逐玩家</span>
</span></span><span class=line><span class=cl>	<span class=k>elif</span> <span class=ow>not</span> <span class=p>(</span><span class=n>_wander_controller</span><span class=o>.</span><span class=n>wandering</span><span class=p>()</span> <span class=ow>or</span> <span class=n>_wander_controller</span><span class=o>.</span><span class=n>alerting</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>randi</span><span class=p>()</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&gt;</span> <span class=n>wander_initiative</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>_action_state</span> <span class=o>=</span> <span class=n>IDLE</span>
</span></span><span class=line><span class=cl>			<span class=n>_wander_controller</span><span class=o>.</span><span class=n>start_alert</span><span class=p>(</span><span class=nb>rand_range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>_action_state</span> <span class=o>=</span> <span class=n>WANDER</span>
</span></span><span class=line><span class=cl>			<span class=n>_wander_controller</span><span class=o>.</span><span class=n>start_wander</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_chase</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>guard_mode</span> <span class=ow>and</span> <span class=n>global_position</span><span class=o>.</span><span class=n>distance_to</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>_wander_controller</span><span class=o>.</span><span class=n>start_position</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>max_chase_range</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>_keep_enmity</span> <span class=o>=</span> <span class=bp>false</span>  <span class=c1># 守卫模式下 追逐距离太远 丢失仇恨</span>
</span></span><span class=line><span class=cl>		<span class=c1># 更好的实现是真的做一个仇恨值(耐心值)系统出来:</span>
</span></span><span class=line><span class=cl>		<span class=c1>#     1. 脱离仇恨范围 仇恨值逐渐降低</span>
</span></span><span class=line><span class=cl>		<span class=c1>#     2. 仇恨值归零后判定为拉脱离仇恨 回满血 无敌(一般表现为 100% 闪避)</span>
</span></span><span class=line><span class=cl>		<span class=c1>#        (大部分 MMORPG 是这样, 不过也有 LOL 这类特例, 追求快节奏, 拉脱只回血不无敌)</span>
</span></span><span class=line><span class=cl>		<span class=c1>#     3. 并且暂时禁用仇恨系统</span>
</span></span><span class=line><span class=cl>		<span class=c1>#     4. 回到出生点后取消无敌 重新启用仇恨系统</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>player</span> <span class=o>=</span> <span class=n>_player_detection</span><span class=o>.</span><span class=n>player</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>player</span> <span class=o>!=</span> <span class=n>null</span> <span class=ow>and</span> <span class=n>_keep_enmity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>move_to_point</span><span class=p>(</span><span class=n>player</span><span class=o>.</span><span class=n>global_position</span><span class=p>,</span> <span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>_action_state</span> <span class=o>=</span> <span class=n>WANDER</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_wander</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>move_to_point</span><span class=p>(</span><span class=n>_wander_controller</span><span class=o>.</span><span class=n>target_position</span><span class=p>,</span> <span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>global_position</span><span class=o>.</span><span class=n>distance_to</span><span class=p>(</span><span class=n>_wander_controller</span><span class=o>.</span><span class=n>target_position</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>_keep_enmity</span> <span class=o>=</span> <span class=bp>true</span>  <span class=c1># 回到出生点 重新恢复仇恨</span>
</span></span><span class=line><span class=cl>		<span class=n>_action_state</span> <span class=o>=</span> <span class=n>IDLE</span>
</span></span><span class=line><span class=cl>		<span class=n>_wander_controller</span><span class=o>.</span><span class=n>stop_wander</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=n>_wander_controller</span><span class=o>.</span><span class=n>start_alert</span><span class=p>(</span><span class=nb>rand_range</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=n>alert_around</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>do_idle</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=n>_move_vector</span> <span class=o>=</span> <span class=n>_move_vector</span><span class=o>.</span><span class=n>move_toward</span><span class=p>(</span><span class=ne>Vector2</span><span class=o>.</span><span class=n>ZERO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nb>max</span><span class=p>(</span><span class=n>friction</span><span class=p>,</span> <span class=mf>10.0</span><span class=p>)</span> <span class=o>*</span> <span class=n>delta</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>_move_vector</span> <span class=o>=</span> <span class=n>move_and_slide</span><span class=p>(</span><span class=n>_move_vector</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>alert_around</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=音效><a href=#音效 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:音效 class=headings>音效</a></h2><p>这个<a href=/tech/game-godot-review-1-prepare/#%E5%BA%94%E8%AF%A5%E5%9C%A8%E4%BB%80%E4%B9%88%E6%97%B6%E6%9C%BA%E4%BD%BF%E7%94%A8%E5%8D%95%E4%BE%8B target=_blank>之前也讲过</a>了。</p><ul><li>单独的场景附带的音效（比如受伤音效，应该是和受击特效动画绑定的）需要自动播放，勾选启用 <code>Autoplay</code>，播放完直接被父节点 <code>queue_free()</code> 释放掉，非常简单。</li><li>常驻的场景（比如玩家节点）待需要时，再现场实例化就是：</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=c1># sound.gd</span>
</span></span><span class=line><span class=cl><span class=k>extends</span> <span class=n>AudioStreamPlayer</span>
</span></span><span class=line><span class=cl><span class=c1># 音效播放器脚本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=n>_ready</span><span class=p>():</span>
</span></span><span class=line><span class=cl>	<span class=k>var</span> <span class=n>err</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;finished&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=p>,</span> <span class=s2>&#34;queue_free&#34;</span><span class=p>)</span>  <span class=c1># 代码连接信号</span>
</span></span><span class=line><span class=cl>	<span class=nb>assert</span><span class=p>(</span><span class=n>err</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>  <span class=c1># 断言没错</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GDScript data-lang=GDScript><span class=line><span class=cl><span class=k>const</span> <span class=n>SOUND</span> <span class=o>=</span> <span class=nb>preload</span><span class=p>(</span><span class=s2>&#34;res://sound.tscn&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>get_parent</span><span class=p>()</span><span class=o>.</span><span class=n>add_child</span><span class=p>(</span><span class=n>SOUND</span><span class=o>.</span><span class=n>instance</span><span class=p>())</span>  <span class=c1># 添加为兄弟节点 防止音效没播放就被 queue_free 打断</span>
</span></span><span class=line><span class=cl><span class=c1># get_tree().current_scene.add_child() 也可以 反正音效在哪放都是放</span>
</span></span></code></pre></td></tr></table></div></div></div><h2 id=视觉特效着色器><a href=#视觉特效着色器 class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a><a href=#contents:视觉特效着色器 class=headings>视觉特效（着色器）</a></h2><p>Sprite > CanvasItem > Material > New ShaderMaterial > New Shader 建立新的<ruby><rb>着色器</rb><rp>（</rp><rt>Shader</rt><rp>）</rp></ruby>，<br>另存为 <code>white_mask.tres</code>（白色蒙版）：</p><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>shader_type</span> <span class=n>canvas_item</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>uniform</span> <span class=kt>bool</span> <span class=n>active</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>fragment</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>vec4</span> <span class=n>previous_pixel</span> <span class=o>=</span> <span class=n>texture</span><span class=p>(</span><span class=n>TEXTURE</span><span class=p>,</span> <span class=n>UV</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>vec4</span> <span class=n>bleached_pixel</span> <span class=o>=</span> <span class=n>vec4</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=n>previous_pixel</span><span class=p>.</span><span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>COLOR</span> <span class=o>=</span> <span class=n>active</span> <span class=o>?</span> <span class=nl>bleached_pixel</span> <span class=p>:</span> <span class=n>previous_pixel</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div><ol><li>首先是定义 <code>shader_type</code>（着色器类型）——<br>有 <code>canvas_item</code>（2D）、<code>spatial</code>（3D）、<code>particle</code>（粒子效果）三种类型。</li><li>然后是 <code>uniform</code>，类似 GDScript 里的 <code>export</code> 导出变量——<br>定义之后可以在外部通过 UI 界面编辑值。<br>（这个功能很强大，你甚至可以导出一个全功能的颜色选择器）</li><li>最后是 <code>fragment()</code> 分片处理函数，这个函数会对目标材质的每一个像素逐一处理。<ol><li>先拿到了原材质的像素数据 <code>previous_pixel</code>。<br>这是一个 <code>vec4</code> 四维向量，四维分别代表 RGBA 四条通道。</li><li>对每一个像素进行<ruby><rb>「漂白」</rb><rp>（</rp><rt>bleach</rt><rp>）</rp></ruby>。（不是《死神》哦 <del>是不是暴露年龄了</del>）</li><li>每一个像素都使用新的 1.0 × 3 的 RGB 值（<code>#ffffff</code>），染成白色。</li><li>但保留原来的 alpha 通道（透明度），这样就原材质就只有存在图形的部分才会被变成白色，而不是包括透明部分的整个区域。</li><li>最后的最后，根据之前导出的变量决定 <code>COLOR</code> 应用 <em>新的颜色</em> 还是 <em>原本的颜色</em>。<br>（标准的三目运算式应该看得懂吧）</li></ol></li></ol><p>接着建立一个 <code>AnimationPlayer</code> 动画节点，没错，多个动画之间可以直接叠加。<br>添加启用和禁用 <code>active</code> 的关键帧，循环播放。目标材质就会在原材质和白色剪影之间切换了。<br>调整动画持续时间，比如开启白色蒙版 0.1 秒，关闭蒙版 0.1 秒，循环，闪烁特效就完成了。</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>此类素材可以用 <a href=https://www.tilesetter.org/downloads target=_blank rel=noopener>Tilesetter</a> 生成。（就是 13 刀有点小贵）&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" class="icon footnote-icon"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg></a></p></li></ol></section></div><ul class=post-copyright><li class="copyright-item author"><span class=copyright-item-text>作者</span>：<a href=https://ews.ink/ class="p-author h-card" target=_blank rel=noopener>time2beat</a></li><li class="copyright-item link"><span class=copyright-item-text>链接</span>：<a href=/tech/game-godot-review-2-tutorial/ target=_blank rel=noopener>https://ews.ink/tech/game-godot-review-2-tutorial/</a></li><li class="copyright-item license"><span class=copyright-item-text>许可</span>：<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a></li></ul></article><div class=updated-badge-container><span title="Updated @2022-10-25 19:28:41 CST" style=cursor:help><svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2022-10-25</text><text x="915" y="140" textLength="650" transform="scale(.1)">2022-10-25</text></g></svg></span></div><div class=post-share><div class=share-items><div class="share-item twitter"><a href="https://twitter.com/share?url=https://ews.ink/tech/game-godot-review-2-tutorial/&text=%e5%a4%8d%e4%b9%a0%20Godot%20%e5%bc%80%e5%8f%91%e6%b5%81%e7%a8%8b%20%e5%85%b6%e4%ba%8c%20%e9%87%8d%e6%b8%a9%e6%95%99%e7%a8%8b&hashtags=Godot,&via=%25!s%28%3cnil%3e%29" title=分享到「Twitter」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon twitter-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a></div><div class="share-item facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://ews.ink/tech/game-godot-review-2-tutorial/&hashtag=%23Godot" title=分享到「Facebook」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon facebook-icon"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a></div><div class="share-item linkedin"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://ews.ink/tech/game-godot-review-2-tutorial/&title=%e5%a4%8d%e4%b9%a0%20Godot%20%e5%bc%80%e5%8f%91%e6%b5%81%e7%a8%8b%20%e5%85%b6%e4%ba%8c%20%e9%87%8d%e6%b8%a9%e6%95%99%e7%a8%8b&summary=%e8%bf%98%e6%98%af%e6%9c%ac%e6%9d%b0%e6%98%8e%e5%a4%a7%e4%bd%ac%e7%9a%84%e3%80%8cMake%20an%20Action%20RPG%20in%20Godot%203.2%e3%80%8d%ef%bc%88%e7%b4%a0%e6%9d%90%ef%bc%89%e8%bf%99%e4%b8%aa%e6%95%99%e7%a8%8b%e3%80%82%20%e8%bf%99%e5%ba%94%e8%af%a5%e6%98%af%e5%88%b7%e7%ac%ac%e5%9b%9b%e9%81%8d%e4%ba%86%ef%bc%8c%e7%9c%9f%e2%80%a6%e2%80%a6&source=Everybody%20Wants%20Some" title=分享到「LinkedIn」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon linkedin-icon"><path d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a></div><div class="share-item telegram"><a href="https://t.me/share/url?url=https://ews.ink/tech/game-godot-review-2-tutorial/&text=%e5%a4%8d%e4%b9%a0%20Godot%20%e5%bc%80%e5%8f%91%e6%b5%81%e7%a8%8b%20%e5%85%b6%e4%ba%8c%20%e9%87%8d%e6%b8%a9%e6%95%99%e7%a8%8b" title=分享到「Telegram」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon telegram-icon"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></a></div><div class="share-item qq"><a href="https://connect.qq.com/widget/shareqq/index.html?url=https://ews.ink/tech/game-godot-review-2-tutorial/&title=%e5%a4%8d%e4%b9%a0%20Godot%20%e5%bc%80%e5%8f%91%e6%b5%81%e7%a8%8b%20%e5%85%b6%e4%ba%8c%20%e9%87%8d%e6%b8%a9%e6%95%99%e7%a8%8b&summary=%e8%bf%98%e6%98%af%e6%9c%ac%e6%9d%b0%e6%98%8e%e5%a4%a7%e4%bd%ac%e7%9a%84%e3%80%8cMake%20an%20Action%20RPG%20in%20Godot%203.2%e3%80%8d%ef%bc%88%e7%b4%a0%e6%9d%90%ef%bc%89%e8%bf%99%e4%b8%aa%e6%95%99%e7%a8%8b%e3%80%82%20%e8%bf%99%e5%ba%94%e8%af%a5%e6%98%af%e5%88%b7%e7%ac%ac%e5%9b%9b%e9%81%8d%e4%ba%86%ef%bc%8c%e7%9c%9f%e2%80%a6%e2%80%a6&pics=https://s2.loli.net/2022/04/10/cF3E2QujLUA5YdC.png&site=Everybody%20Wants%20Some" title=分享到「QQ」 target=_blank rel=noopener><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qq-icon"><path d="M433.754 420.445c-11.526 1.393-44.86-52.741-44.86-52.741.0 31.345-16.136 72.247-51.051 101.786 16.842 5.192 54.843 19.167 45.803 34.421-7.316 12.343-125.51 7.881-159.632 4.037-34.122 3.844-152.316 8.306-159.632-4.037-9.045-15.25 28.918-29.214 45.783-34.415-34.92-29.539-51.059-70.445-51.059-101.792.0.0-33.334 54.134-44.859 52.741-5.37-.65-12.424-29.644 9.347-99.704 10.261-33.024 21.995-60.478 40.144-105.779C60.683 98.063 108.982.006 224 0c113.737.006 163.156 96.133 160.264 214.963 18.118 45.223 29.912 72.85 40.144 105.778 21.768 70.06 14.716 99.053 9.346 99.704z"/></svg></a></div><div class="share-item qrcode"><div class=qrcode-container title=通过「二维码」><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon qrcode-icon"><path d="M0 224h192V32H0v192zM64 96h64v64H64V96zm192-64v192h192V32H256zm128 128h-64V96h64v64zM0 480h192V288H0v192zm64-128h64v64H64v-64zm352-64h32v128h-96v-32h-32v96h-64V288h96v32h64v-32zm0 160h32v32h-32v-32zm-64 0h32v32h-32v-32z"/></svg><div id=qrcode-img></div></div><script src=https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js></script>
<script>const typeNumber=0,errorCorrectionLevel="L",qr=qrcode(typeNumber,errorCorrectionLevel);qr.addData("https://ews.ink/tech/game-godot-review-2-tutorial/"),qr.make(),document.getElementById("qrcode-img").innerHTML=qr.createImgTag()</script></div></div></div><div class=related-posts><h2 class=related-title>相关文章：<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon related-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm144 276c0 6.6-5.4 12-12 12h-92v92c0 6.6-5.4 12-12 12h-56c-6.6.0-12-5.4-12-12v-92h-92c-6.6.0-12-5.4-12-12v-56c0-6.6 5.4-12 12-12h92v-92c0-6.6 5.4-12 12-12h56c6.6.0 12 5.4 12 12v92h92c6.6.0 12 5.4 12 12v56z"/></svg></h2><ul class=related-list><li class=related-item><a href=/tech/game-mahjong-fact-gdd/ class=related-link>日麻游戏《雀实》游戏设计文档</a></li><li class=related-item><a href=/tech/game-godot-trick-instance-tilemap/ class=related-link>Godot 3.4 使用 TileMap 实例化场景</a></li><li class=related-item><a href=/tech/game-godot-review-1-prepare/ class=related-link>复习 Godot 开发流程 其一 前期准备</a></li><li class=related-item><a href=/tech/game-mahjong-diy/ class=related-link>手写一个日麻游戏</a></li></ul></div><footer class=minimal-footer><div class=post-tag><a href=/tags/godot/ rel=tag class=post-tag-link>#godot</a></div><div class=post-category><a href=/tech/ class="post-category-link active">tech</a> | <a href=/game/ class=post-category-link>game</a> | <a href=/life/ class=post-category-link>life</a></div></footer><ul class=post-nav><li class=post-nav-prev><a href=/tech/game-godot-trick-instance-tilemap/ rel=prev>&lt; Godot 3.4 使用 TileMap 实例化场景</a></li><li class=post-nav-next><a href=/tech/game-godot-review-1-prepare/ rel=next>复习 Godot 开发流程 其一 前期准备 ></a></li></ul></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>©&nbsp;2018–2022&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;time2beat</div><div class=site-copyright><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a></div><div class=custom-footer><a href=//beian.miit.gov.cn/>蜀ICP备17037841号-1</a></div></div></footer></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css><script>if(typeof renderMathInElement=="undefined"){const e=t=>{const e=document.createElement("script");e.defer=!0,e.crossOrigin="anonymous",Object.keys(t).forEach(n=>{e[n]=t[n]}),document.body.appendChild(e)};e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js",onload:()=>{e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/mhchem.min.js",onload:()=>{e({src:"https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js",onload:()=>{renderKaTex()}})}})}})}else renderKaTex();function renderKaTex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})}</script><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script>
<script>mediumZoom(document.querySelectorAll("div.post-body img:not(a img, .sticker img, .ygo-card img, img[no-zoom], img[data-sticker], img[data-emoji], img.no-zoom, img.sticker, img.emoji)"),{background:"hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)"})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script>
<script async src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>